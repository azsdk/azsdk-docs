# OMS Solution for AzSDK
 ### Contents
- [Overview](Alert_Montoring_userguide.md#overview)
- [Routing AzSDK events to OMS](Alert_Montoring_userguide.md#routing-azsdk-events-to-oms)
- [Contents of the AzSDK OMS Solution](Alert_Montoring_userguide.md#contents-of-the-azsdk-oms-solution)
- [Setting up the AzSDK OMS Solution (Step by Step)](Alert_Montoring_userguide.md#setting-up-the-azsdk-oms-solution-step-by-step)
- [Next Steps](Alert_Montoring_userguide.md#next-steps)

--------------------------
### Overview 
The OMS solution for AzSDK provides the ops team with a single dashboard to view the security state/trends of one or more of the following:
- Subscription and Application state/trends in early development stages 
- Subscription and Application state/trends in CICD pipelines as reported by AzSDK SVTs
- Subscription and Application state/trends as reported via AzSDK continuous compliance runbooks

[Back to top…](Alert_Montoring_userguide.md#contents)

### Routing AzSDK events to OMS
Note that the Security Verification Tests (SVTs) from AzSDK can be run in 3 stages:
1. Development ("SDL")
2. Build/Deployment ("CICD")
3. Continuous Assurance ("CC")

Depending on the stage the way to wire up the SVTs/runbooks with OMS is different. 

1. In the development ("SDL") stage, the following command can be used to set the OMS workspace that will collect events generated via various AzSDK-scripts/SVTs etc. in a subscription:

```PowerShell
 Set-AzSDKOMSSettings -OMSWorkspaceID <OMSWorkspaceID> -OMSSharedKey <OMSSharedKey>
```

2. In the CICD stage, the OMS settings can be specified in the input parameters for the [AzSDK SVTs build/release task](../03-Security-In-CICD/Security_In_CICD_userguide.md).
3. For the CC runbooks, the OMS workspace info specified in the input parameters of the [Continuous Assurance setup script](../04-Continous-Assurance/Continuous_Assurance_userguide.md).  

Events sent from these (different devops) stages of one or more applications get aggregated in the OMS workspace alongside events from the various out-of-box solution packs available in the OMS gallery. The OMS solution for AzSDK leverages the out-of-box solution packs (such as Log Analytics, Alerts, etc.) and AzSDK events to provide an overall view of security across the different DevOps stages for these applications. The picture below shows a conceptual view of this.  

![05_Aggregate_View_of_security_in_OMS](../Images/05_Aggregate_View_of_security_in_OMS.png)

[Back to top…](Alert_Montoring_userguide.md#contents)

### Contents of the AzSDK OMS Solution
The OMS solution is basically an ARM template that an end user can deploy on the subscription where the OMS workspace resides. Based on a few key inputs provided by the end user, the solution creates a template deployment which builds and sets up all the necessary artifacts required for security state visibility and monitoring.

The out of box security dashboard generated by the OMS solution enables scenarios such as the following:
1. Summary view of critical tasks that require immediate attention
2. Outcomes of the most recent 'Continuous Compliance' scans
3. Simple search queries to get started with AzSDK
4. Trends of various security metrics and activity over time

**A- View of tiles in the main dashboard**

![05_Main_Dashboard_View](../Images/05_Main_Dashboard_View.png)

**B- AzSDK Searches and Alerts**
	
![05_Subscription_Security_View](../Images/05_Subscription_Security_View.png)

**C- Application Security View**

![05_Application_Security_View](../Images/05_Application_Security_View.png)

[Back to top…](Alert_Montoring_userguide.md#contents)

### Setting up the AzSDK OMS Solution (Step by Step)
This section will walk you through the step-by-step experience of setting up the AzSDK OMS solution. 
The workflow involves two sets of steps - one set to be run by the central PU team that owns the OMS workspace and
the other set to be run by the application team (for apps which are to be monitored via the central OMS dashboard).
We will refer to the central BU team as the "**Ops team**" and the application team as "**App team**" below.

**Note**: In a single/small team scenario, both of these personas could be the same person/group and the OMS subscription could be the same as the application subscription. These steps should still apply.

The general model this assumes is one where there are (1) multiple subscriptions covering a portfolio of applications for a BU and (2) a central subscription that hosts the OMS workspace for that BU. We call the former 'app subscriptions' and the latter 'OMS subscription'.

At a high level, we will be performing the following steps:
1. Create an OMS workspace in the central subscription
2. Configure the app subscription to send events to this OMS workspace
3. Install the AzSDK OMS Solution Pack in the OMS workspace
4. View security status/alerts/etc.

**Step-1 (Ops team):** Create a new OMS workspace.
Go to https://mms.microsoft.com and follow the simple steps to create a new OMS workspace.
	
![05_Setting_OMS_Workspace_New_OMS](../Images/05_Setting_OMS_Workspace_New_OMS.png)

**Note:** If you already have an OMS workspace, then that can be used as well (i.e., you don't have to create a fresh one just for the AzSDK solution pack). Indeed, the idea is that the security views appear alongside other views on the operations dashboard and not in a standalone one.

**Step-2 (Ops Team):** Associate with an Azure Subscription. This should be the central subscription that is to host the OMS workspace.

![05_Setting_OMS_Workspace_Select_Subscription](../Images/05_Setting_OMS_Workspace_Select_sub.png)  

**Step-3 (Ops Team):** Capture the WorkspaceID and PrimaryKey for the workspace by clicking on "Settings" for the OMS workspace and navigating to "Connected Sources -> Windows Servers".

![05_Setting_OMS_Workspace_Setting](../Images/05_Setting_OMS_Workspace_Setting.png)

![05_Setting_OMS_Workspace_Primary_Key](../Images/05_Setting_OMS_Workspace_Primary_Key.png)

As an aside, after concluding setup for the OMS workspace, you will also get an email for email address confirmation such as the one below:

![05_Setting_OMS_Workspace_Email_Confirmation](../Images/05_Setting_OMS_Workspace_Email_Confirmation.png)
	
**Step-3x: (Ops Team)** Add Alert Management Solution Pack from OMS Solution Gallery (choose default installation) in the OMS subscription.

![05_Setting_OMS_Workspace_Solution_Gallery](../Images/05_Setting_OMS_Workspace_Solution_Gallery.png)
![05_Setting_OMS_Workspace_Alert_Management](../Images/05_Setting_OMS_Workspace_Alert_Management.png)
	
**Step-3y: (Ops Team)** Add Activity Log Analytics Solution Pack from the gallery (see pic above) and configure it (steps below).
After you install the Activity Log Solution Pack from the gallery, it's dashboard tile directs you to do connect a log source as shown below:
	
![05_Setting_OMS_Workspace_Activity_Log_Analytics](../Images/05_Setting_OMS_Workspace_Activity_Log_Analytics.png)

1. This connection is setup in the OMS subscription by going into the Log Analytics feature and clicking on "Azure Activity Log" in the Workspace Data Sources list as below:

![05_Setting_OMS_Workspace_Azure_Activity_Log](../Images/05_Setting_OMS_Workspace_Azure_Activity_Log.png)  

2. From the OMS Subscription, one can view all subscriptions that the Ops team person (current user) has at least "Reader" level access as options for 'Connecting' to Log Analytics pack. It means that App team subscriptions will show here as an option only if at least "Reader" access is granted to the current OMS user. (This is an OMS product requirement.)  

Choose the subscription(s) corresponding to the apps that are being monitored and click 'Connect'.
      
![05_Setting_OMS_Workspace_Connecting_Log_Analytics](../Images/05_Setting_OMS_Workspace_Connecting_Log_Analytics.png)
	
Note: The above steps have to be done from the OMS subscription.

At this point, the app subscription is setup to pipe it's Activity Log events to the OMS workspace. 

In the next 2 steps we will configure AzSDK to send data to the OMS workspace from a PS session. This is just so that we can verify that custom events that AzSDK generates are getting to OMS correctly. 

**Step-4 (App Team):** Connect the application subscription to the above OMS workspace for sending AzSDK events.
Run the below code in a PS session after logging in to Azure (assumes you also have the latest AzSDK installed).
```PowerShell
 $wsID = 'oms_workspace_id_here'
 $shrKey = 'workspace_sharedKey_here'
	
 Set-AzSDKOMSSettings -OMSWorkspaceID $wsID -OMSSharedKey $shrKey
```
After doing so, AzSDK cmdlets, SVTs, etc. will chart sending events (outcomes of security scans) into the OMS repository represented by the workspaceID above.

**Step-5 (App Team):** Run a few AzSDK cmdlets to generate events for the OMS repo. 
This can be done by running one or both of the below:
```PowerShell
 Get-AzSDKSubscriptionSecurityStatus -SubscriptionId $subID 
 Get-AzSDKAzureServicesSecurityStatus -SubscriptionId $subID -ResourceGroupName 'app_rg_name'
```

After the above, if we go into OMS Log Search and search for 'AzSDK_CL', it should show events similar to the below ("_CL" stands for "custom log"):
	
![05_Setting_OMS_Workspace_Custom_Log](../Images/05_Setting_OMS_Workspace_Custom_Log.png)

**Step-6 (Ops Team): AzSDK OMS Solution Pack**

You could run the below command to get the details about your OMS workspace

```PowerShell
 Get-AzureRmOperationalInsightsWorkspace 
```

The output from that command should look like the below (showing the OMS workspaces from the subscription that is currently chosen in PS via **Set-AzureRmContext**):

![05_Get_AzureRmOperationalInsightsWorkspace](../Images/05_Get_AzureRmOperationalInsightsWorkspace.png)

This can be done by running one or both of the below:
```PowerShell
    $omsSubscriptionId ='<omsSubId>'
    $omsResourceGroupName ='<omsResourceGroupName>'
    $OMSWorkspaceName ='<omsWsName>'
    $applicationSubscriptionId ='<appSubId>'
    $applicationResourceGroups ='<appResourceGroups>'
    $applicationName ='<appName>'
    $securityPointOfContactEmails = '<semicolon separated email list>'

    Install-AzSDKOMSSolution -OMSSubscriptionId $omsSubscriptionId -OMSResourceGroup $omsResourceGroupName -OMSWorkspaceName $OMSWorkspaceName `
                         -ApplicationSubscriptionId $applicationSubscriptionId -ApplicationResourceGroups $applicationResourceGroups -ApplicationName $applicationName `
                         -SecurityContactEmails $securityPointOfContactEmails 
```

|ParameterName|Comments|
| ----- | ---- | 
|OMSSubscriptionId|Id of the subscription where the OMS Workspace is in|
|OMSResourceGroup|name of the resource group where the OMS Workspace is in|
|OMSWorkspaceName|OMS Workspace name which is used for monitoring your subscriptions|
|ApplicationSubscriptionId|Id of the subscription which needs to be monitored|
|ApplicationResourceGroups|Comma separated values of resource groups which needs to be monitored|
|ApplicationName|Name of the application hosted on the specified resource groups|
|SecurityContactEmails|Security point of contacts, who would be notified in the case of an event|
|OMSInstallationOption|"All"=> install all the features of OMS pack, "Queries"=> installs AzSDK sample queries, "SampleView"=> install sample AzSDK security view, "Alerts"=> configures OMS workspace with alerts for ciritcal security failures|

(A resource group name looking like 'mms-xxx' is used by the default OMS setup process (where 'xxx' can be 'eus' or 'sea' etc. based on the region). If you specified a custom resource group name, then use that for the command above. **The Get-AzureRmOperationalInsightsWorkspace** will show the correct value to use for the respective OMS workspace.)

This will produce output like the below:
	
![05_Install-AzSDKOMSSecurityPack](../Images/05_Install-AzSDKOMSSecurityPack.png)
      
The installation script does the following:
1. Adds an AzSDK-xxx view to the OMS workspace (including a tile for the main OMS dashboard)
2. Adds multiple "Saved Searches" (Work-In-Progress - WIP), 
3. Configures security-related alerts inside the OMS workspace (WIP), 
4. Install various schedules (for the above alerts) (WIP)

At this point, the application's subscription is setup for AzSDK OMS monitoring. We will setup the application itself separately further below.

In the next step, we will look at the subscription view artifacts.

![05_Setting_OMS_Workspace_Subscription_View_Artifacts](../Images/05_Main_Dashboard_View.png)

**Step-7 (Ops Team):** Viewing the various artifacts in the AzSDK OMS Solution Pack

**7-(a)** Viewing the events that have come across from the app sub.
Click on the 'magnifier' icon in the taskbar on the left to open the "Log Search" page.
Enter "Type=AzSDK_CL" in the query field.
	
![05_Setting_OMS_Workspace_Log_Search_Query](../Images/05_Setting_OMS_Workspace_Log_Search_Query.png) 

You should see the data from the AzSDK cmdlet that were run by the app team (to generate some events in Step-5).

![05_Setting_OMS_Workspace_Log_Search](../Images/05_Setting_OMS_Workspace_Log_Search.png)
	
**7(b)** AzSDK Solution View
The solution view contains multiple blades representing alerts, various types of security activity, security trends, etc.
	
![05_Setting_OMS_Workspace_Solution_View](../Images/05_Application_Security_View.png)

The above mentioned is just the sample view. You could configure different views based on your application monitoring needs.
Below are other such sample views, which provide visibility of Azure security controls across devops stages.

At this point, we can confirm that the ad hoc security scan we ran in Steps 4, 5 above generated data for the application security control status by looking at the view (by clicking the tile above).

![05_Setting_OMS_Workspace_App_Specific_View_Details_1](../Images/05_Setting_OMS_Workspace_App_Specific_View_Details_1.png)
	
If you also have CICD integration setup, you can trigger a new deployment and also start seeing the AzSDK control evaluation results from CICD in the OMS workspace (as shown below):

![05_Setting_OMS_Workspace_App_Specific_View_Details_2](../Images/05_Setting_OMS_Workspace_App_Specific_View_Details_2.png)

Lastly, if you also setup continuous assurance (AzSDK CC runbooks), you will also see activity in the first blade as shown below:

![05_Setting_OMS_Workspace_App_Specific_View_Details_3](../Images/05_Setting_OMS_Workspace_App_Specific_View_Details_3.png)
	

[Back to top…](Alert_Montoring_userguide.md#contents)

### Next Steps
Now you can view, track and respond to security events in one or more applications from the OMS workspace.

[Back to top…](Alert_Montoring_userguide.md#contents)

